{{left_sidebar_enabled,right_sidebar_enabled=False,('message' in globals())}}
{{extend 'layout.html'}}
{{block right_sidebar}}
{{pass}}

<h4>Nueva entrada</h4>

<div class="container-fluid">
  <div class="well well-small">
      {{=form.custom.begin}}

        <div class="row-fluid">

          <div class="row-fluid">
            <div class="span1" id="fechas">Fecha: {{=form.custom.widget.Fecha}}</div>
            <div class="span3">Donante: {{=form.custom.widget.Donante}}</div>
            <div class="span3">Procedencia: {{=form.custom.widget.tipoProcedencia}}</div>
           
          </div>
           <div class="row-fluid">
             {{=form.custom.submit}}
           </div>
        </div>
      {{=form.custom.end}}
  </div>

  <div class="row-fluid">
    <h5>Líneas:</h5>
      <div class="well well-small">





        <div class="row-fluid">
              <div class="span1">Código: 
                <input class="integer" id="Alimento_Codigo" name="Codigo" type="text" value="" style="width:50px">
              </div>
{{=frmlineas.custom.begin}}
              <div class="span3">{{=frmlineas.custom.label.alimento}}:
                {{=frmlineas.custom.widget.alimento}}
               </div> 
                <div class="span1">{{=frmlineas.custom.label.Unidades}}:
                {{=frmlineas.custom.widget.Unidades}}
               </div>  
                <div class="span1">{{=frmlineas.custom.label.PesoUnidad}}:
                {{=frmlineas.custom.widget.PesoUnidad}}
               </div>
                <div class="span2">{{=frmlineas.custom.label.PrecioKg}}:
                {{=frmlineas.custom.widget.PrecioKg}}
               </div> 
        </div>
       <div class="row-fluid">
              <div class="span1">{{=frmlineas.custom.label.Caducidad}}:
                {{=frmlineas.custom.widget.Caducidad}}
               </div> 
                <div class="span1">{{=frmlineas.custom.label.Lote}}:
                {{=frmlineas.custom.widget.Lote}}
               </div>  
                <div class="span1">{{=frmlineas.custom.label.estanteria}}:
                {{=frmlineas.custom.widget.estanteria}}
               </div>
                <div class="span3">
                {{=frmlineas.custom.submit}} 
               </div> 
       </div>
       <div class="row-fluid">
                      
       </div>        
{{=frmlineas.custom.end}}

      </div> <!-- fin del well lineas-->

    <table id="list"></table>
    <div id="pager"></div>


  </div>  
 

</div>


 <style>
      
      .ui-pg-input{width:20px;}
      .ui-pg-selbox{width:50px;padding-top: 0px;}
    #CabeceraEntrada_Fecha{ width: 80px;}
    #LineaEntrada_Unidades{ width: 80px;}
    #LineaEntrada_PesoUnidad{ width: 80px;}
    #LineaEntrada_PrecioKg{ width: 80px;}
    #LineaEntrada_alimento{ width: 260px;}
    #LineaEntrada_Caducidad{ width: 80px;}
    #LineaEntrada_Lote{ width: 80px;}
    #LineaEntrada_estanteria{ width: 80px;}
    #LineaEntrada_LineaAlmacen{ width: 80px;}
    #pager_left{width:10px;}
    .well {margin-bottom:2px;}
    h5 
  </style>


<script type="text/javascript">

 $(document).ready(function() {
   // chrome fix.
   document.onselectstart = function () { return false; };             

   jQuery("#Alimento_Familia").focus();
   
   jQuery("#Alimento_Familia").change(function() {
      jQuery("#Alimento_SubFamilia").empty();
      ajax("get_subfamilias",["Familia"],"subfamilias");
      jQuery("#list").jqGrid().trigger("reloadGrid");
   });
    
   jQuery("#subfamilias").on('change',"#Alimento_SubFamilia",function() {
        var jsonString={'subfamilia':  jQuery("#Alimento_SubFamilia").val() };
        jQuery.post('set_subfamilia', jsonString, {contentType: 'application/json'} )
              .success(function(data) {           
                    jQuery("#list").jqGrid().trigger("reloadGrid");     
              });
        
      });




   //var cachealimentos={}

   jQuery('#Alimento_Descripcion').autocomplete({
      minLength: 2,
      source: function( request, response ) {
            /*var term = request.term;
            if ( term in cachealimentos ) {
              response( cachealimentos[ term ] );
              return;
            }*/
            jQuery.getJSON( 'get_alimentos?subf='+ jQuery("#Alimento_SubFamilia").val() + '&fam=' + jQuery("#Alimento_Familia").val(), 
              request, function( data, status, xhr ) {
              //cachealimentos[ term ] = data;
              response( data );
            });
        },
    select: function( event, ui ) {
      var jsonString={'alimento':  ui.item.value};
      jQuery.post('set_alimento', jsonString, {contentType: 'application/json;charset=utf-8'} )
            .success(function(data) {           
                  jQuery("#list").jqGrid().trigger("reloadGrid");     
            });

    }        

    });





  jQuery("#list").jqGrid({
    url:'{{=URL(r=request,f="call",args=["json","get_lineas_entradas"])}}',
    data: "{}",
    datatype: 'json',
    mtype: 'GET',
    contentType: "application/json; charset=utf-8",
    cellEdit: true,
    cellsubmit:'remote',
    cellurl: '{{=URL(r=request,f="call",args=["json","save_cell"])}}',
    complete: function(jsondata, stat) {
        if (stat == "success") {
            var thegrid = jQuery("#list")[0];
            thegrid.addJSONData(JSON.parse(jsondata.responseText).d);
        }
    },
    colNames:['Alimento','Unidades','Peso/Unidad','Caducidad','Lote','Estanteria'],

    colModel :[
      
      {name:'Alimento', index:'Descripcion',width:250},
      {name:'Unidades', index:'Familia',width:70,align:"center"},
      {name:'Peso/Unidad', index:'SubFamilia',width:90,align:"center"},
      {name:'Caducidad', index:'Conservacion',width:70,align:"center"},
      {name:'Lote', index:'Stock',width:70,align:"center"},
      {name:'Estanteria', index:'Unidades',width:70,align:"center"},
    ],
    pager: '#pager',
    rowNum:10,
    rowList:[10,20,30],
    sortname: 'Descripcion',
    sortorder: 'asc',
    viewrecords: true,
    caption: 'Líneas de esta entrada de almacén',
    altRows:true,
    height: 'auto',
    width: 'auto',
  subGrid : false,
 
  });


  });

</script>
